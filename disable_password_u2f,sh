#!/bin/bash

set -e

U2F_LINE_PATTERN="pam_u2f.so"
BACKUP_DIR_LATEST=$(ls -td /etc/pam.d/u2f-2fa-backup-* 2>/dev/null | head -n1)

echo "üßπ Reverting Password + U2F 2FA..."

if [[ -n "$BACKUP_DIR_LATEST" ]]; then
    echo "üì¶ Restoring from backup: $BACKUP_DIR_LATEST"
    for backup_file in "$BACKUP_DIR_LATEST"/*; do
        orig="/etc/pam.d/$(basename "$backup_file")"
        cp "$backup_file" "$orig"
        echo "  ‚Üí Restored $orig"
    done
else
    echo "‚ö†Ô∏è No backup found. Removing pam_u2f.so manually."
    for file in /etc/pam.d/login /etc/pam.d/sudo /etc/pam.d/su /etc/pam.d/gdm-password /etc/pam.d/lightdm; do
        if [[ -f "$file" ]]; then
            sed -i "/$U2F_LINE_PATTERN/d" "$file"
            echo "  ‚Üí Cleaned $file"
        fi
    done
fi

echo "‚úÖ U2F removed; password-only auth restored."
